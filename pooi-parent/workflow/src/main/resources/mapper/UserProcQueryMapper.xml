<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="app.pooi.workflow.infrastructure.persistence.mapper.workflow.procquery.UserProcQueryMapper">

    <select id="selectUserCompletedProcessTaskIds"
            resultType="app.pooi.workflow.infrastructure.persistence.entity.workflow.procquery.UserCompletedProcessTaskResult">
        select proc_inst.ID_             as processInstanceId,
               group_concat(hi_task.ID_) as taskIds
        from ACT_HI_TASKINST hi_task
                 inner join ACT_HI_PROCINST proc_inst on hi_task.PROC_INST_ID_ = proc_inst.PROC_INST_ID_
        where hi_task.ASSIGNEE_ = #{query.userId}
          and hi_task.TENANT_ID_ = #{query.applicationCode}
          and hi_task.END_TIME_ is not null
          and proc_inst.TENANT_ID_ = #{query.applicationCode}
        group by proc_inst.PROC_INST_ID_
        order by max(hi_task.END_TIME_) desc
    </select>

    <!--    <select id="selectAttachmentCountByQueryCriteria" parameterType="app.pooi.workflow.query.AttachmentQuery" resultType="long">-->
    <!--        select count(distinct RES.ID_)-->
    <!--        <include refid="selectAttachmentByQueryCriteriaSql"/>-->
    <!--    </select>-->

    <!--    <select id="selectAttachmentByQueryCriteria" parameterType="app.pooi.workflow.query.AttachmentQuery" resultMap="org.flowable.engine.impl.persistence.entity.AttachmentEntityImpl.attachmentResultMap">-->
    <!--        <if test="needsPaging">${limitBefore}</if>-->
    <!--        SELECT RES.* <if test="needsPaging">${limitBetween}</if>-->
    <!--        <include refid="selectAttachmentByQueryCriteriaSql"/>-->
    <!--        ${orderBy}-->
    <!--        <if test="needsPaging">${limitAfter}</if>-->
    <!--    </select>-->

    <!--    <sql id="selectAttachmentByQueryCriteriaSql">-->
    <!--        from ${prefix}ACT_HI_ATTACHMENT RES-->
    <!--        <where>-->
    <!--            <if test="attachmentId != null">-->
    <!--                RES.ID_ = #{attachmentId}-->
    <!--            </if>-->
    <!--            <if test="attachmentName != null">-->
    <!--                and RES.NAME_ = #{attachmentName}-->
    <!--            </if>-->
    <!--            <if test="attachmentType != null">-->
    <!--                and RES.TYPE_ = #{attachmentType}-->
    <!--            </if>-->
    <!--            <if test="userId != null">-->
    <!--                and RES.USER_ID_ = #{userId}-->
    <!--            </if>-->
    <!--            <if test="taskId != null">-->
    <!--                and RES.TASK_ID_ = #{taskId}-->
    <!--            </if>-->
    <!--            <if test="processInstanceId != null">-->
    <!--                and RES.PROC_INST_ID_ = #{processInstanceId}-->
    <!--            </if>-->
    <!--        </where>-->
    <!--    </sql>-->
</mapper>